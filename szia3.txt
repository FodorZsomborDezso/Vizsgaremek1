const express = require('express');
const mysql = require('mysql2/promise');
const bcrypt = require('bcrypt');
const jwt = require('jsonwebtoken');

const app = express();
const PORT = 3000;
const JWT_SECRET = 'your-secret-key-change-this';

// Middleware
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Adatbázis kapcsolat létrehozása
const pool = mysql.createPool({
    host: 'localhost',
    user: 'root',
    password: '',
    database: 'artisticeye_db',
    waitForConnections: true,
    connectionLimit: 10,
    queueLimit: 0,
    charset: 'utf8mb4'
});

// JWT autentikáció middleware
const authenticateToken = async (req, res, next) => {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1];

    if (!token) {
        return res.status(401).json({ error: 'Nincs token megadva' });
    }

    try {
        const user = jwt.verify(token, JWT_SECRET);
        req.user = user;
        next();
    } catch (error) {
        return res.status(403).json({ error: 'Érvénytelen token' });
    }
};

// ==================== USERS CRUD ====================

// GET /users - Összes felhasználó listázása
app.get('/users', async (req, res) => {
    try {
        const [rows] = await pool.query(`
            SELECT id, username, email, full_name, bio, location, website, avatar_url, created_at 
            FROM users
        `);
        res.json(rows);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// GET /users/:id - Egy felhasználó lekérése
app.get('/users/:id', async (req, res) => {
    try {
        const [rows] = await pool.query(
            'SELECT id, username, email, full_name, bio, location, website, avatar_url, created_at FROM users WHERE id = ?',
            [req.params.id]
        );
        if (rows.length === 0) {
            return res.status(404).json({ error: 'Felhasználó nem található' });
        }
        res.json(rows[0]);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// POST /users/register - Új felhasználó regisztrációja
app.post('/users/register', async (req, res) => {
    try {
        const { username, email, password, full_name, bio, location, website } = req.body;

        // Kötelező mezők ellenőrzése
        if (!username || !email || !password) {
            return res.status(400).json({ error: 'A felhasználónév, email és jelszó megadása kötelező' });
        }

        // Jelszó hash-elése
        const hashedPassword = await bcrypt.hash(password, 10);

        const [result] = await pool.query(
            `INSERT INTO users (username, email, password_hash, full_name, bio, location, website, avatar_url)
             VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
            [username, email, hashedPassword, full_name || null, bio || null, location || null, website || null, 'https://via.placeholder.com/150']
        );

        res.status(201).json({
            id: result.insertId,
            username,
            email,
            message: 'Felhasználó sikeresen létrehozva'
        });
    } catch (error) {
        if (error.code === 'ER_DUP_ENTRY') {
            res.status(400).json({ error: 'A felhasználónév vagy email már létezik' });
        } else {
            res.status(500).json({ error: error.message });
        }
    }
});

// POST /users/login - Bejelentkezés
app.post('/users/login', async (req, res) => {
    try {
        const { email, password } = req.body;

        const [users] = await pool.query('SELECT * FROM users WHERE email = ?', [email]);
        const user = users[0];

        if (!user) {
            return res.status(401).json({ error: 'Hibás email vagy jelszó' });
        }

        const validPassword = await bcrypt.compare(password, user.password_hash);
        if (!validPassword) {
            return res.status(401).json({ error: 'Hibás email vagy jelszó' });
        }

        const token = jwt.sign(
            { id: user.id, username: user.username, email: user.email },
            JWT_SECRET,
            { expiresIn: '24h' }
        );

        res.json({
            token,
            user: {
                id: user.id,
                username: user.username,
                email: user.email,
                full_name: user.full_name,
                avatar_url: user.avatar_url
            }
        });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// PUT /users/:id - Felhasználó módosítása (védett)
app.put('/users/:id', authenticateToken, async (req, res) => {
    try {
        // Csak a saját profilját módosíthatja
        if (req.user.id != req.params.id) {
            return res.status(403).json({ error: 'Csak a saját profilodat módosíthatod' });
        }

        const { username, full_name, bio, location, website, avatar_url } = req.body;

        const [result] = await pool.query(
            `UPDATE users 
             SET username = ?, full_name = ?, bio = ?, location = ?, website = ?, avatar_url = ?
             WHERE id = ?`,
            [username, full_name, bio, location, website, avatar_url, req.params.id]
        );

        if (result.affectedRows === 0) {
            return res.status(404).json({ error: 'Felhasználó nem található' });
        }

        res.json({ message: 'Felhasználó sikeresen módosítva' });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// DELETE /users/:id - Felhasználó törlése (védett)
app.delete('/users/:id', authenticateToken, async (req, res) => {
    try {
        if (req.user.id != req.params.id) {
            return res.status(403).json({ error: 'Csak a saját profilodat törölheted' });
        }

        const [result] = await pool.query('DELETE FROM users WHERE id = ?', [req.params.id]);

        if (result.affectedRows === 0) {
            return res.status(404).json({ error: 'Felhasználó nem található' });
        }

        res.json({ message: 'Felhasználó sikeresen törölve' });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// ==================== POSTS CRUD ====================

// GET /posts - Összes poszt listázása
app.get('/posts', async (req, res) => {
    try {
        const [rows] = await pool.query(`
            SELECT p.*, u.username, u.avatar_url, c.name as category_name
            FROM posts p
            LEFT JOIN users u ON p.user_id = u.id
            LEFT JOIN categories c ON p.category_id = c.id
            ORDER BY p.created_at DESC
        `);
        res.json(rows);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// GET /posts/:id - Egy poszt lekérése
app.get('/posts/:id', async (req, res) => {
    try {
        const [rows] = await pool.query(`
            SELECT p.*, u.username, u.avatar_url, c.name as category_name
            FROM posts p
            LEFT JOIN users u ON p.user_id = u.id
            LEFT JOIN categories c ON p.category_id = c.id
            WHERE p.id = ?
        `, [req.params.id]);

        if (rows.length === 0) {
            return res.status(404).json({ error: 'Poszt nem található' });
        }

        // Like-ok számának lekérése
        const [likes] = await pool.query(
            'SELECT COUNT(*) as like_count FROM likes WHERE post_id = ?',
            [req.params.id]
        );
        rows[0].like_count = likes[0].like_count;

        res.json(rows[0]);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// POST /posts - Új poszt létrehozása (védett)
app.post('/posts', authenticateToken, async (req, res) => {
    try {
        const { category_id, idea_id, title, description, image_url } = req.body;

        if (!image_url) {
            return res.status(400).json({ error: 'A kép URL megadása kötelező' });
        }

        const [result] = await pool.query(
            `INSERT INTO posts (user_id, category_id, idea_id, title, description, image_url)
             VALUES (?, ?, ?, ?, ?, ?)`,
            [req.user.id, category_id || null, idea_id || null, title || null, description || null, image_url]
        );

        res.status(201).json({
            id: result.insertId,
            user_id: req.user.id,
            message: 'Poszt sikeresen létrehozva'
        });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// PUT /posts/:id - Poszt módosítása (védett)
app.put('/posts/:id', authenticateToken, async (req, res) => {
    try {
        // Ellenőrizzük, hogy a felhasználó tulajdonosa-e a posztnak
        const [posts] = await pool.query('SELECT user_id FROM posts WHERE id = ?', [req.params.id]);
        if (posts.length === 0) {
            return res.status(404).json({ error: 'Poszt nem található' });
        }
        if (posts[0].user_id !== req.user.id) {
            return res.status(403).json({ error: 'Csak a saját posztjaidat módosíthatod' });
        }

        const { category_id, idea_id, title, description, image_url } = req.body;

        const [result] = await pool.query(
            `UPDATE posts 
             SET category_id = ?, idea_id = ?, title = ?, description = ?, image_url = ?
             WHERE id = ?`,
            [category_id, idea_id, title, description, image_url, req.params.id]
        );

        res.json({ message: 'Poszt sikeresen módosítva' });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// DELETE /posts/:id - Poszt törlése (védett)
app.delete('/posts/:id', authenticateToken, async (req, res) => {
    try {
        // Ellenőrizzük, hogy a felhasználó tulajdonosa-e a posztnak
        const [posts] = await pool.query('SELECT user_id FROM posts WHERE id = ?', [req.params.id]);
        if (posts.length === 0) {
            return res.status(404).json({ error: 'Poszt nem található' });
        }
        if (posts[0].user_id !== req.user.id) {
            return res.status(403).json({ error: 'Csak a saját posztjaidat törölheted' });
        }

        await pool.query('DELETE FROM posts WHERE id = ?', [req.params.id]);
        res.json({ message: 'Poszt sikeresen törölve' });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// ==================== IDEAS CRUD ====================

// GET /ideas - Összes ötlet listázása
app.get('/ideas', async (req, res) => {
    try {
        const [rows] = await pool.query(`
            SELECT i.*, u.username, c.name as category_name
            FROM ideas i
            LEFT JOIN users u ON i.user_id = u.id
            LEFT JOIN categories c ON i.category_id = c.id
            ORDER BY i.created_at DESC
        `);
        res.json(rows);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// POST /ideas - Új ötlet létrehozása (védett)
app.post('/ideas', authenticateToken, async (req, res) => {
    try {
        const { category_id, title, description } = req.body;

        if (!title || !description) {
            return res.status(400).json({ error: 'A cím és leírás megadása kötelező' });
        }

        const [result] = await pool.query(
            `INSERT INTO ideas (user_id, category_id, title, description)
             VALUES (?, ?, ?, ?)`,
            [req.user.id, category_id, title, description]
        );

        res.status(201).json({
            id: result.insertId,
            message: 'Ötlet sikeresen létrehozva'
        });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// PUT /ideas/:id - Ötlet módosítása (védett)
app.put('/ideas/:id', authenticateToken, async (req, res) => {
    try {
        const [ideas] = await pool.query('SELECT user_id FROM ideas WHERE id = ?', [req.params.id]);
        if (ideas.length === 0) {
            return res.status(404).json({ error: 'Ötlet nem található' });
        }
        if (ideas[0].user_id !== req.user.id) {
            return res.status(403).json({ error: 'Csak a saját ötleteidet módosíthatod' });
        }

        const { category_id, title, description } = req.body;

        await pool.query(
            `UPDATE ideas SET category_id = ?, title = ?, description = ? WHERE id = ?`,
            [category_id, title, description, req.params.id]
        );

        res.json({ message: 'Ötlet sikeresen módosítva' });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// DELETE /ideas/:id - Ötlet törlése (védett)
app.delete('/ideas/:id', authenticateToken, async (req, res) => {
    try {
        const [ideas] = await pool.query('SELECT user_id FROM ideas WHERE id = ?', [req.params.id]);
        if (ideas.length === 0) {
            return res.status(404).json({ error: 'Ötlet nem található' });
        }
        if (ideas[0].user_id !== req.user.id) {
            return res.status(403).json({ error: 'Csak a saját ötleteidet törölheted' });
        }

        await pool.query('DELETE FROM ideas WHERE id = ?', [req.params.id]);
        res.json({ message: 'Ötlet sikeresen törölve' });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// ==================== CATEGORIES CRUD ====================

// GET /categories - Összes kategória listázása
app.get('/categories', async (req, res) => {
    try {
        const [rows] = await pool.query('SELECT * FROM categories ORDER BY name');
        res.json(rows);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// POST /categories - Új kategória létrehozása (csak admin - egyszerűsítve)
app.post('/categories', authenticateToken, async (req, res) => {
    try {
        const { name } = req.body;

        if (!name) {
            return res.status(400).json({ error: 'A kategória név megadása kötelező' });
        }

        const [result] = await pool.query('INSERT INTO categories (name) VALUES (?)', [name]);

        res.status(201).json({
            id: result.insertId,
            name,
            message: 'Kategória sikeresen létrehozva'
        });
    } catch (error) {
        if (error.code === 'ER_DUP_ENTRY') {
            res.status(400).json({ error: 'A kategória már létezik' });
        } else {
            res.status(500).json({ error: error.message });
        }
    }
});

// PUT /categories/:id - Kategória módosítása
app.put('/categories/:id', authenticateToken, async (req, res) => {
    try {
        const { name } = req.body;

        const [result] = await pool.query(
            'UPDATE categories SET name = ? WHERE id = ?',
            [name, req.params.id]
        );

        if (result.affectedRows === 0) {
            return res.status(404).json({ error: 'Kategória nem található' });
        }

        res.json({ message: 'Kategória sikeresen módosítva' });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// DELETE /categories/:id - Kategória törlése
app.delete('/categories/:id', authenticateToken, async (req, res) => {
    try {
        const [result] = await pool.query('DELETE FROM categories WHERE id = ?', [req.params.id]);

        if (result.affectedRows === 0) {
            return res.status(404).json({ error: 'Kategória nem található' });
        }

        res.json({ message: 'Kategória sikeresen törölve' });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// ==================== LIKES CRUD ====================

// POST /posts/:id/like - Like hozzáadása/eltávolítása (védett)
app.post('/posts/:id/like', authenticateToken, async (req, res) => {
    try {
        // Ellenőrizzük, hogy létezik-e a poszt
        const [posts] = await pool.query('SELECT id FROM posts WHERE id = ?', [req.params.id]);
        if (posts.length === 0) {
            return res.status(404).json({ error: 'Poszt nem található' });
        }

        // Ellenőrizzük, hogy már like-olta-e
        const [existingLike] = await pool.query(
            'SELECT * FROM likes WHERE user_id = ? AND post_id = ?',
            [req.user.id, req.params.id]
        );

        if (existingLike.length > 0) {
            // Ha már like-olta, akkor töröljük a like-ot
            await pool.query(
                'DELETE FROM likes WHERE user_id = ? AND post_id = ?',
                [req.user.id, req.params.id]
            );
            res.json({ message: 'Like eltávolítva', liked: false });
        } else {
            // Ha nem like-olta, akkor hozzáadjuk
            await pool.query(
                'INSERT INTO likes (user_id, post_id) VALUES (?, ?)',
                [req.user.id, req.params.id]
            );
            res.json({ message: 'Like hozzáadva', liked: true });
        }
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// GET /posts/:id/likes - Like-ok listázása egy poszthoz
app.get('/posts/:id/likes', async (req, res) => {
    try {
        const [rows] = await pool.query(`
            SELECT l.*, u.username, u.avatar_url
            FROM likes l
            JOIN users u ON l.user_id = u.id
            WHERE l.post_id = ?
        `, [req.params.id]);

        res.json(rows);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// ==================== FOLLOWS CRUD ====================

// POST /users/:id/follow - Felhasználó követése/le követése (védett)
app.post('/users/:id/follow', authenticateToken, async (req, res) => {
    try {
        if (req.user.id == req.params.id) {
            return res.status(400).json({ error: 'Nem követheted saját magad' });
        }

        // Ellenőrizzük, hogy létezik-e a felhasználó
        const [users] = await pool.query('SELECT id FROM users WHERE id = ?', [req.params.id]);
        if (users.length === 0) {
            return res.status(404).json({ error: 'Felhasználó nem található' });
        }

        // Ellenőrizzük, hogy már követi-e
        const [existingFollow] = await pool.query(
            'SELECT * FROM follows WHERE follower_id = ? AND followed_id = ?',
            [req.user.id, req.params.id]
        );

        if (existingFollow.length > 0) {
            // Ha már követi, akkor töröljük a követést
            await pool.query(
                'DELETE FROM follows WHERE follower_id = ? AND followed_id = ?',
                [req.user.id, req.params.id]
            );
            res.json({ message: 'Követés megszüntetve', following: false });
        } else {
            // Ha nem követi, akkor követés
            await pool.query(
                'INSERT INTO follows (follower_id, followed_id) VALUES (?, ?)',
                [req.user.id, req.params.id]
            );
            res.json({ message: 'Felhasználó követve', following: true });
        }
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// GET /users/:id/followers - Követők listázása
app.get('/users/:id/followers', async (req, res) => {
    try {
        const [rows] = await pool.query(`
            SELECT u.id, u.username, u.full_name, u.avatar_url, f.created_at as followed_since
            FROM follows f
            JOIN users u ON f.follower_id = u.id
            WHERE f.followed_id = ?
        `, [req.params.id]);

        res.json(rows);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// GET /users/:id/following - Követettek listázása
app.get('/users/:id/following', async (req, res) => {
    try {
        const [rows] = await pool.query(`
            SELECT u.id, u.username, u.full_name, u.avatar_url, f.created_at as following_since
            FROM follows f
            JOIN users u ON f.followed_id = u.id
            WHERE f.follower_id = ?
        `, [req.params.id]);

        res.json(rows);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// ==================== DASHBOARD / STATISZTIKÁK ====================

// GET /dashboard/:userId - Felhasználói dashboard
app.get('/dashboard/:userId', async (req, res) => {
    try {
        const userId = req.params.userId;

        // Posztok száma
        const [postsCount] = await pool.query(
            'SELECT COUNT(*) as count FROM posts WHERE user_id = ?',
            [userId]
        );

        // Ötletek száma
        const [ideasCount] = await pool.query(
            'SELECT COUNT(*) as count FROM ideas WHERE user_id = ?',
            [userId]
        );

        // Követők száma
        const [followersCount] = await pool.query(
            'SELECT COUNT(*) as count FROM follows WHERE followed_id = ?',
            [userId]
        );

        // Követettek száma
        const [followingCount] = await pool.query(
            'SELECT COUNT(*) as count FROM follows WHERE follower_id = ?',
            [userId]
        );

        // Kapott like-ok száma
        const [likesReceived] = await pool.query(`
            SELECT COUNT(*) as count
            FROM likes l
            JOIN posts p ON l.post_id = p.id
            WHERE p.user_id = ?
        `, [userId]);

        res.json({
            user_id: userId,
            posts: postsCount[0].count,
            ideas: ideasCount[0].count,
            followers: followersCount[0].count,
            following: followingCount[0].count,
            likes_received: likesReceived[0].count
        });
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// ==================== SEARCH ====================

// GET /search - Keresés posztokban és felhasználókban
app.get('/search', async (req, res) => {
    try {
        const { q, type } = req.query;

        if (!q) {
            return res.status(400).json({ error: 'Keresési kifejezés megadása kötelező' });
        }

        const searchTerm = `%${q}%`;
        let results = {};

        if (!type || type === 'posts') {
            const [posts] = await pool.query(`
                SELECT p.*, u.username, u.avatar_url, c.name as category_name
                FROM posts p
                LEFT JOIN users u ON p.user_id = u.id
                LEFT JOIN categories c ON p.category_id = c.id
                WHERE p.title LIKE ? OR p.description LIKE ?
                ORDER BY p.created_at DESC
                LIMIT 20
            `, [searchTerm, searchTerm]);
            results.posts = posts;
        }

        if (!type || type === 'users') {
            const [users] = await pool.query(`
                SELECT id, username, full_name, bio, location, avatar_url
                FROM users
                WHERE username LIKE ? OR full_name LIKE ? OR bio LIKE ?
                LIMIT 20
            `, [searchTerm, searchTerm, searchTerm]);
            results.users = users;
        }

        if (!type || type === 'ideas') {
            const [ideas] = await pool.query(`
                SELECT i.*, u.username, c.name as category_name
                FROM ideas i
                LEFT JOIN users u ON i.user_id = u.id
                LEFT JOIN categories c ON i.category_id = c.id
                WHERE i.title LIKE ? OR i.description LIKE ?
                ORDER BY i.created_at DESC
                LIMIT 20
            `, [searchTerm, searchTerm]);
            results.ideas = ideas;
        }

        res.json(results);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// Szerver indítása
app.listen(PORT, () => {
    console.log(`Szerver fut a http://localhost:${PORT} címen`);
    console.log('Elérhető végpontok:');
    console.log('  GET  /users');
    console.log('  GET  /users/:id');
    console.log('  POST /users/register');
    console.log('  POST /users/login');
    console.log('  PUT  /users/:id');
    console.log('  DELETE /users/:id');
    console.log('  GET  /posts');
    console.log('  POST /posts');
    console.log('  GET  /posts/:id');
    console.log('  PUT  /posts/:id');
    console.log('  DELETE /posts/:id');
    console.log('  POST /posts/:id/like');
    console.log('  GET  /ideas');
    console.log('  POST /ideas');
    console.log('  GET  /categories');
    console.log('  POST /users/:id/follow');
    console.log('  GET  /search?q=keyword');
});